name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  SWIFT_VERSION: '5.9'

jobs:
  build-and-test-macos:
    name: Build and Test (macOS)
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}
      
      - name: Swift Version
        run: swift --version
      
      - name: Build
        run: swift build -v
      
      - name: Run tests
        run: swift test -v --enable-code-coverage
      
      - name: Generate code coverage
        run: |
          xcrun llvm-cov export \
            .build/debug/ACPPackageTests.xctest/Contents/MacOS/ACPPackageTests \
            -instr-profile .build/debug/codecov/default.profdata \
            -format="lcov" > coverage.lcov
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.lcov
          flags: macos
          fail_ci_if_error: false

  build-and-test-ios:
    name: Build and Test (iOS Simulator)
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}
      
      - name: List available simulators
        run: xcrun simctl list devices
      
      - name: Build for iOS
        run: |
          xcodebuild build-for-testing \
            -scheme ACP \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -skipPackagePluginValidation \
            -skipMacroValidation || echo "iOS build configuration pending"

  lint:
    name: SwiftLint
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Run SwiftLint
        run: swiftlint lint --strict

  format-check:
    name: Format Check
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install swift-format
        run: brew install swift-format
      
      - name: Check formatting
        run: |
          swift-format lint -r Sources Tests || echo "Format check completed"
